<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>VG Scan</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#0b1220">
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./sw.js").catch(()=>{});
    }
  </script>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;800&display=swap" rel="stylesheet">

  <style>
    :root{--bg:#0b1220;--card:#121a2b;--line:#22304a;--text:#e6eefb;--muted:#9db0c8;--accent:#4da6ff;--good:#7be495;--warn:#ffd166;--bad:#ff6b6b}
    *{box-sizing:border-box}
    body{margin:0;font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    .wrap{max-width:760px;margin:0 auto;padding:14px}
    .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .brand{font-weight:900;letter-spacing:.2px}
    .muted{color:var(--muted)}
    .card{background:linear-gradient(180deg, rgba(18,26,43,.95), rgba(15,23,42,.95));
      border:1px solid var(--line);border-radius:18px;padding:12px;box-shadow:0 12px 30px rgba(0,0,0,.25)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input,select{flex:1;min-width:160px;padding:12px;border-radius:12px;border:1px solid var(--line);background:#0f172a;color:var(--text);outline:none}
    button{padding:12px 14px;border-radius:12px;border:1px solid var(--line);background:rgba(77,166,255,.15);color:var(--text);font-weight:900}
    button:disabled{opacity:.6}
    .pill{display:inline-block;border:1px solid var(--line);background:#0f172a;border-radius:999px;padding:8px 10px;font-size:13px}
    .bar{height:3px;background:rgba(77,166,255,.35);border-radius:99px;margin:12px 0}
    .hidden{display:none !important}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#0f172a;border:1px solid var(--line);
      padding:10px 12px;border-radius:12px;max-width:92vw;display:none}
    #reader{border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#0f172a}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">VG • Scan Only</div>
      <div class="muted" style="font-size:12px" id="who">Not logged in</div>
    </div>

    <div class="card" id="loginCard">
      <div style="font-weight:900;margin-bottom:8px">Staff Login</div>
      <div class="row">
        <input id="email" type="email" placeholder="Email" autocomplete="username">
        <input id="pass" type="password" placeholder="Password" autocomplete="current-password">
      </div>
      <div class="row" style="margin-top:10px">
        <button id="btnLogin">LOGIN</button>
      </div>
      <div class="muted" style="font-size:12px;margin-top:10px">
        * Same login mo ito sa main system.
      </div>
    </div>

    <div class="card hidden" id="scanCard">
      <div class="row" style="justify-content:space-between">
        <div style="font-weight:900">Scanner</div>
        <div>
          <button id="btnLogout">LOGOUT</button>
        </div>
      </div>

      <div class="bar"></div>

      <div id="reader"></div>

      <div class="bar"></div>

      <div class="row">
        <span class="pill">Detected: <b id="detected">—</b></span>
        <button id="btnReset" class="hidden">Scan Again</button>
      </div>

      <div class="row" style="margin-top:10px">
        <select id="status">
          <option value="" disabled selected>Select Status</option>
          <option>Picked Up (Origin)</option>
          <option>Departed Origin</option>
          <option>In Transit</option>
          <option>Arrived at Hub</option>
          <option>Out for Delivery</option>
          <option>Delivered</option>
        </select>

        <select id="hub" onchange="toggleCustomHub()">
          <option value="" disabled selected>Select Hub...</option>
        </select>

        <input id="hubCustom" class="hidden" placeholder="New location (e.g., TAGUM HUB)">
      </div>

      <div class="row" style="margin-top:10px">
        <button id="btnUpdate">UPDATE & SAVE</button>
      </div>

      <div class="muted" style="font-size:12px;margin-top:10px">
        * Kapag “➕ Add New Location…”, isi-save din niya sa locations list.
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion, onSnapshot } 
      from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } 
      from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

    // SAME firebaseConfig mo (galing sa current index.html)
    const firebaseConfig = {
      apiKey: "AIzaSyCrDEUr1O5krXFHEB2hafLXuEumEcoSTxM",
      authDomain: "vg-cargo-system-3.firebaseapp.com",
      projectId: "vg-cargo-system-3",
      storageBucket: "vg-cargo-system-3.firebasestorage.app",
      messagingSenderId: "819520192535",
      appId: "1:819520192535:web:8e42b272500f9b60e19c52"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const $ = (id)=>document.getElementById(id);
    const toastEl = $("toast");
    function toast(msg){
      toastEl.textContent = msg;
      toastEl.style.display = "block";
      clearTimeout(window.__t);
      window.__t = setTimeout(()=>toastEl.style.display="none", 2200);
    }

    let scanner = null;
    let currentUserEmail = null;

    function loadLocations(){
      const hubSel = $("hub");
      const defaultHubs = ["MNL HUB (Manila)","DVO HUB (Davao)","CEB HUB (Cebu)","ILO HUB (Iloilo)","CGY HUB (Cagayan)","GES HUB (Gensan)","Rider (On Delivery)"];
      onSnapshot(doc(db,"settings","locations"), (snap)=>{
        let hubs = defaultHubs;
        if(snap.exists() && snap.data().list) hubs = snap.data().list;
        hubs = [...new Set(hubs)].filter(Boolean).sort();
        let html = `<option value="" disabled selected>Select Hub...</option>`;
        hubs.forEach(h=> html += `<option value="${h}">${h}</option>`);
        html += `<option value="Other">➕ Add New Location...</option>`;
        hubSel.innerHTML = html;
      }, ()=>{
        let html = `<option value="" disabled selected>Select Hub...</option>`;
        defaultHubs.forEach(h=> html += `<option value="${h}">${h}</option>`);
        html += `<option value="Other">➕ Add New Location...</option>`;
        hubSel.innerHTML = html;
      });
    }

    window.toggleCustomHub = function toggleCustomHub(){
      const v = $("hub").value;
      $("hubCustom").classList.toggle("hidden", v !== "Other");
      if(v === "Other") $("hubCustom").focus();
    }

    function startCamera(){
      if(scanner) return;

      // Try to support QR + CODE_128 (safe fallback)
      let config = { fps: 10, qrbox: 250, rememberLastUsedCamera: true };
      try{
        if(window.Html5QrcodeSupportedFormats){
          config.formatsToSupport = [
            window.Html5QrcodeSupportedFormats.QR_CODE,
            window.Html5QrcodeSupportedFormats.CODE_128
          ];
        }
      }catch(e){}

      scanner = new Html5QrcodeScanner("reader", config, false);
      scanner.render((text)=>{
        $("detected").textContent = text;
        $("btnReset").classList.remove("hidden");
        try{ scanner.pause(); }catch(e){}
      }, ()=>{});
    }

    function stopCamera(){
      if(!scanner) return;
      scanner.clear().catch(()=>{}); 
      scanner = null;
    }

    $("btnReset").addEventListener("click", ()=>{
      $("detected").textContent = "—";
      $("status").value = "";
      $("hub").value = "";
      $("hubCustom").value = "";
      $("hubCustom").classList.add("hidden");
      $("btnReset").classList.add("hidden");
      try{ scanner && scanner.resume(); }catch(e){}
    });

    $("btnLogin").addEventListener("click", async ()=>{
      const e = $("email").value.trim();
      const p = $("pass").value.trim();
      if(!e || !p) return toast("Missing email/password");
      try{
        await signInWithEmailAndPassword(auth, e, p);
      }catch(err){
        toast(err?.message || "Login failed");
      }
    });

    $("btnLogout").addEventListener("click", async ()=>{
      await signOut(auth);
      location.reload();
    });

    $("btnUpdate").addEventListener("click", async ()=>{
      const wb = ($("detected").textContent || "").trim();
      const s  = $("status").value;
      let l    = $("hub").value;

      if(!wb || wb === "—") return toast("No waybill detected");
      if(!s) return toast("Select Status");
      if(!l) return toast("Select Hub/Location");

      let isCustom = false;
      if(l === "Other"){
        l = $("hubCustom").value.trim();
        if(!l) return toast("Enter new location");
        isCustom = true;
      }

      try{
        await updateDoc(doc(db,"parcels",wb), {
          currentStatus: s,
          history: arrayUnion({ status:s, location:l, time:new Date().toLocaleString(), user: currentUserEmail })
        });

        if(isCustom){
          await setDoc(doc(db,"settings","locations"), { list: arrayUnion(l) }, { merge:true });
        }

        toast("Updated successfully");
        $("btnReset").click();
      }catch(err){
        toast("Error: " + (err?.message || err));
      }
    });

    onAuthStateChanged(auth, async (user)=>{
      if(user){
        currentUserEmail = user.email;
        $("who").textContent = user.email;
        $("loginCard").classList.add("hidden");
        $("scanCard").classList.remove("hidden");
        loadLocations();
        startCamera();
      }else{
        currentUserEmail = null;
        $("who").textContent = "Not logged in";
        $("scanCard").classList.add("hidden");
        $("loginCard").classList.remove("hidden");
        stopCamera();
      }
    });
  </script>
</body>
</html>
