<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VG Freightage Admin</title>
    
    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@700&display=swap" rel="stylesheet"> 
    
    <style>
        body { background-color: #f8f9fa; font-family: 'Montserrat', sans-serif; overflow-x: hidden; }
        :root { --vg-blue: #001f60; --vg-green: #00c853; --vg-red: #d32f2f; }

        .navbar { background-color: white; border-bottom: 3px solid var(--vg-blue); }
        .hero-section { background: linear-gradient(135deg, var(--vg-blue) 0%, #000c24 100%); color: white; padding: 40px 20px; text-align: center; border-radius: 0 0 20px 20px; margin-bottom: 30px; }
        
        /* SCANNER FIXES */
        #reader { width: 100%; border-radius: 10px; overflow: hidden; background: black; min-height: 300px; }
        #reader video { object-fit: cover; border-radius: 10px; }
        
        .btn-menu { height: 90px; border: 1px solid #eee; border-radius: 12px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .icon-box { color: var(--vg-blue); margin-bottom: 5px; }
        .card { border-top: 5px solid var(--vg-green); border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .hidden { display: none !important; }

        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 31, 96, 0.95); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 40px; border-radius: 15px; width: 90%; max-width: 350px; text-align: center; }

        /* AIRLINE TICKET STYLE */
        #printArea { display: none; }
        @media print {
            #publicView, #staffView, #loginOverlay, .navbar { display: none !important; }
            #printArea { display: block !important; width: 100%; margin: 0; padding: 0; }
            @page { size: 100mm 150mm; margin: 0; }
            .sticker-page { width: 100mm; height: 149mm; margin: 0 auto; border: 4px solid black; background: white; color: black; font-family: 'Oswald', sans-serif; display: flex; flex-direction: column; box-sizing: border-box; padding: 0; page-break-after: always; break-after: always; page-break-inside: avoid; overflow: hidden; }
            .wb-header { display: flex; align-items: center; justify-content: space-between; padding: 5px 8px; border-bottom: 2px solid black; background: #eee; -webkit-print-color-adjust: exact; }
            .wb-brand-box { display: flex; align-items: center; gap: 5px; }
            .wb-logo { height: 20px; }
            .wb-company-text { font-family: 'Oswald', sans-serif; font-size: 14px; font-weight: bold; color: black; letter-spacing: 0.5px; }
            .wb-date { font-size: 9px; font-weight: bold; }
            .wb-sort-zone { background: black; color: white; text-align: center; font-family: 'Oswald', sans-serif; font-size: 42px; font-weight: bold; line-height: 1; padding: 2px 0; letter-spacing: 3px; text-transform: uppercase; border-bottom: 2px solid black; -webkit-print-color-adjust: exact; }
            .wb-warning-banner { background: white; color: black; border-bottom: 2px solid black; text-align: center; font-family: 'Oswald', sans-serif; font-weight: 900; font-size: 24px; padding: 5px; text-transform: uppercase; letter-spacing: 2px; display: none; }
            .wb-warning-banner.show { display: block; background: black !important; color: white !important; -webkit-print-color-adjust: exact; }
            .wb-qr-section { display: flex; justify-content: space-between; align-items: center; padding: 5px 8px; border-bottom: 2px solid black; }
            .wb-id-box { text-align: left; }
            .wb-id-label { font-size: 8px; color: #555; font-weight: bold; text-transform: uppercase; }
            .wb-id-text { font-size: 28px; font-weight: 900; letter-spacing: 1px; font-family: 'Oswald', sans-serif; }
            .wb-qr-code { padding: 0; } 
            .wb-sender { padding: 8px; border-bottom: 1px solid black; font-size: 11px; line-height: 1.2; }
            .wb-receiver { padding: 10px; flex-grow: 1; display: flex; flex-direction: column; justify-content: center; }
            .wb-tag { background: black; color: white; font-size: 10px; font-weight: bold; padding: 2px 5px; display: inline-block; width: fit-content; margin-bottom: 5px; -webkit-print-color-adjust: exact; }
            .wb-rcv-name { font-size: 32px; font-weight: 900; line-height: 1.1; margin-bottom: 5px; text-transform: uppercase; font-family: 'Oswald', sans-serif; }
            .wb-rcv-addr { font-size: 14px; font-weight: bold; line-height: 1.2; margin-bottom: 3px; }
            .wb-footer { display: flex; border-top: 3px solid black; height: 50px; }
            .wb-f-item { flex: 1; border-right: 2px solid black; display: flex; flex-direction: column; align-items: center; justify-content: center; }
            .wb-f-item:last-child { border-right: none; }
            .wb-f-lbl { font-size: 8px; font-weight: bold; text-transform: uppercase; }
            .wb-f-val { font-size: 18px; font-weight: 900; }
        }
    </style>
</head>
<body>

<!-- LOGIN -->
<div id="loginOverlay" class="hidden">
    <div class="login-box">
        <img src="logo.png" style="height: 60px; margin-bottom: 20px;" onerror="this.src='https://cdn-icons-png.flaticon.com/512/754/754769.png'">
        <h4 style="color:var(--vg-blue); font-weight:800;">STAFF LOGIN</h4>
        <input type="email" id="loginEmail" class="form-control mb-2" placeholder="Email">
        <input type="password" id="loginPass" class="form-control mb-3" placeholder="Password">
        <button class="btn btn-primary w-100" onclick="login()">LOGIN</button>
    </div>
</div>

<!-- PUBLIC TRACKING -->
<div id="publicView">
    <nav class="navbar shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="#">
                <img src="logo.png" alt="VG" onerror="this.style.display='none'">
                <span class="brand-text fw-bold" style="color:var(--vg-blue)">VG FREIGHTAGE</span>
            </a>
            <button class="btn btn-outline-secondary btn-sm ms-auto" onclick="openLogin()"><i class="fas fa-lock"></i> Staff</button>
        </div>
    </nav>
    <div class="hero-section">
        <h2 class="fw-bold mb-2">Track Your Package</h2>
        <div class="d-flex justify-content-center">
            <div style="max-width:500px; width:100%;">
                <input type="text" id="publicSearchInput" class="form-control form-control-lg text-center fw-bold mb-2" placeholder="Enter Waybill No.">
                <button class="btn btn-success w-100 fw-bold" onclick="publicTrack()">TRACK NOW</button>
            </div>
        </div>
    </div>
    <div class="container"><div id="publicResult" class="row justify-content-center"></div></div>
</div>

<!-- STAFF PANEL -->
<div id="staffView" class="hidden">
    <nav class="navbar sticky-top">
        <div class="container">
            <a class="navbar-brand" href="#">
                <img src="logo.png" alt="VG" onerror="this.style.display='none'">
                <span class="fw-bold text-dark">STAFF PANEL</span>
            </a>
            <div class="d-flex align-items-center">
                <small class="me-2 fw-bold text-muted d-none d-md-block" id="displayEmail"></small>
                <span id="roleBadge" class="badge bg-secondary me-2">...</span>
                <button class="btn btn-sm btn-danger" onclick="logout()">Exit</button>
            </div>
        </div>
    </nav>
    <div class="container mt-4">
        <div class="row text-center mb-4 g-2">
            <div class="col-4"><button class="btn btn-light w-100 btn-menu shadow-sm" onclick="showPage('create')"><div class="icon-box"><i class="fas fa-box-open fa-2x"></i></div><small>Create</small></button></div>
            <div class="col-4"><button class="btn btn-light w-100 btn-menu shadow-sm" onclick="showPage('scanner')"><div class="icon-box"><i class="fas fa-qrcode fa-2x"></i></div><small>Scan</small></button></div>
            <div class="col-4"><button class="btn btn-light w-100 btn-menu shadow-sm" onclick="showPage('tracker')"><div class="icon-box"><i class="fas fa-search fa-2x"></i></div><small>Track</small></button></div>
            <div class="col-12 mt-2 hidden" id="adminMenuBtn">
                <button class="btn btn-light w-100 btn-menu shadow-sm border-danger" onclick="showPage('users')"><div class="icon-box text-danger"><i class="fas fa-user-shield fa-2x"></i></div><small class="text-danger fw-bold">ADMIN</small></button>
            </div>
        </div>

        <!-- CREATE TAB -->
        <div id="create" class="staff-page hidden">
            <div class="card p-4">
                <h5 class="text-primary fw-bold mb-3">Create Waybill</h5>
                <div class="input-group mb-3"><input type="text" id="wbInput" class="form-control fw-bold"><button class="btn btn-secondary" onclick="generateRandomWB()">Auto</button></div>
                <div class="row g-2 mb-3">
                    <div class="col-6"><label class="small text-muted fw-bold">ORIGIN</label><input type="text" id="shipperAddr" class="form-control fw-bold" placeholder="e.g. Manila Hub"></div>
                    <div class="col-6"><label class="small text-muted fw-bold">DESTINATION</label><input type="text" id="consigneeAddr" class="form-control fw-bold" placeholder="e.g. Davao Hub"></div>
                </div>
                <div class="row g-2 mb-3">
                    <div class="col-6"><label class="small">Total Qty</label><input type="number" id="qty" class="form-control" placeholder="1" value="1"></div>
                    <div class="col-6"><label class="small">Weight (kg)</label><input type="text" id="weight" class="form-control" placeholder="0"></div>
                </div>
                <div class="mb-3">
                    <label class="fw-bold small text-muted">SPECIAL HANDLING</label>
                    <select id="handling" class="form-select fw-bold border-warning">
                        <option value="Standard">Standard (None)</option>
                        <option value="FRAGILE">‚ö†Ô∏è FRAGILE</option>
                        <option value="PERISHABLE">üêü PERISHABLE</option>
                        <option value="FRAGILE & PERISHABLE">‚ö†Ô∏è FRAGILE & PERISHABLE</option>
                    </select>
                </div>
                <button class="btn btn-primary w-100 fw-bold" onclick="createParcel()">SAVE & PRINT</button>
            </div>
        </div>

        <!-- SCANNER TAB (FIXED CAMERA & LOGIC) -->
        <div id="scanner" class="staff-page hidden">
            <div class="card p-4">
                <h5 class="text-primary fw-bold">Scanner</h5>
                
                <!-- CAMERA BOX -->
                <div id="reader"></div>
                
                <!-- ACTION AREA -->
                <div id="scanAction" class="hidden mt-3">
                    <div class="alert alert-info py-2 text-center mb-2">
                        WAYBILL: <strong id="detectedWB" class="text-dark">...</strong>
                    </div>
                    
                    <label class="fw-bold small text-muted">CURRENT LOCATION / ACTION</label>
                    <!-- DYNAMIC DROPDOWN -->
                    <select id="currentLocSelect" class="form-select mb-2 fw-bold border-primary" onchange="toggleCustomLoc()" style="font-size:1.1rem; padding:10px;">
                        <option value="" disabled selected>Loading...</option>
                    </select>
                    
                    <input type="text" id="currentLocCustom" class="form-control mb-2 hidden" placeholder="Type NEW Location Name">
                    
                    <button class="btn btn-success w-100 py-2 fw-bold" onclick="updateStatus()">
                        <i class="fas fa-check-circle"></i> UPDATE NOW
                    </button>
                    <button class="btn btn-secondary w-100 mt-2 btn-sm" onclick="resetScan()">Cancel</button>
                </div>
            </div>
        </div>

        <!-- TRACKER TAB -->
        <div id="tracker" class="staff-page hidden">
            <div class="card p-4">
                <h5 class="text-primary fw-bold">Internal Tracker</h5>
                <div class="input-group mb-3"><input type="text" id="staffTrackInput" class="form-control" placeholder="Waybill No."><button class="btn btn-primary" onclick="staffTrackParcel()">Search</button></div>
                <div id="staffTrackResult"></div>
                <div id="reprintSection" class="hidden mt-3 p-3 bg-light border rounded">
                    <h6 class="fw-bold small text-muted mb-2">REPRINT OPTIONS</h6>
                    <div class="row g-2 align-items-center">
                        <div class="col-auto"><small>From:</small></div>
                        <div class="col"><input type="number" id="rpStart" class="form-control form-control-sm text-center" value="1" min="1"></div>
                        <div class="col-auto"><small>To:</small></div>
                        <div class="col"><input type="number" id="rpEnd" class="form-control form-control-sm text-center" value="1" min="1"></div>
                        <div class="col-12 mt-2"><button class="btn btn-warning w-100 fw-bold btn-sm" onclick="reprintRange()"><i class="fas fa-print me-1"></i> PRINT STICKERS</button></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ADMIN TAB -->
        <div id="users" class="staff-page hidden">
            <div class="card p-4 border-danger">
                <h5 class="text-danger fw-bold">Admin Zone</h5>
                <button class="btn btn-success w-100 mb-3" onclick="exportToExcel()">Download Report</button>
                <div class="p-3 bg-light border rounded mb-3"><h6>Create Account</h6><input type="email" id="newEmail" class="form-control mb-2" placeholder="Email"><input type="password" id="newPassword" class="form-control mb-2" placeholder="Password"><button class="btn btn-secondary w-100" onclick="createStaffAccount()">Create</button></div>
                <div class="p-3 bg-white border rounded border-warning mb-3"><h6 class="text-warning fw-bold">Manage Roles</h6><div class="input-group"><input type="email" id="manageEmail" class="form-control" placeholder="User Email"><button class="btn btn-danger" onclick="setRole('Admin')">Admin</button><button class="btn btn-secondary" onclick="setRole('Staff')">Staff</button></div></div>
                <div id="logsContainer" class="small text-muted p-2 border bg-white" style="height: 100px; overflow-y: scroll;">Logs...</div>
            </div>
        </div>
    </div>
</div>

<div id="printArea"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion, collection, addDoc, query, orderBy, limit, getDocs, onSnapshot } 
    from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword } 
    from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

    // *** FIREBASE CONFIG ***
    const firebaseConfig = {
      apiKey: "AIzaSyCrDEUr1O5krXFHEB2hafLXuEumEcoSTxM",
      authDomain: "vg-cargo-system-3.firebaseapp.com",
      projectId: "vg-cargo-system-3",
      storageBucket: "vg-cargo-system-3.firebasestorage.app",
      messagingSenderId: "819520192535",
      appId: "1:819520192535:web:8e42b272500f9b60e19c52"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    window.db = db; window.auth = auth;
    window.doc = doc; window.setDoc = setDoc; window.getDoc = getDoc; window.updateDoc = updateDoc;
    window.arrayUnion = arrayUnion; window.collection = collection; window.addDoc = addDoc;
    window.query = query; window.orderBy = orderBy; window.limit = limit; window.getDocs = getDocs; 
    window.onSnapshot = onSnapshot;
    window.signInWithEmailAndPassword = signInWithEmailAndPassword; window.signOut = signOut;
    window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            document.getElementById('displayEmail').innerText = user.email;
            window.currentUserEmail = user.email;
            loadLocations(); // START LISTENING FOR LOCATIONS
            
            let role = "Staff"; 
            if (user.email === "nephiprudencio68@gmail.com") role = "Admin"; 
            else { try { const d = await getDoc(doc(db, "users", user.email.toLowerCase())); if(d.exists()) role = d.data().role; } catch(e){} }
            
            document.getElementById('roleBadge').innerText = role;
            if (role === "Admin") { document.getElementById('roleBadge').classList.replace('bg-secondary', 'bg-danger'); document.getElementById('adminMenuBtn').classList.remove('hidden'); } 
            else { document.getElementById('roleBadge').classList.replace('bg-danger', 'bg-secondary'); document.getElementById('adminMenuBtn').classList.add('hidden'); }
            
            document.getElementById('publicView').classList.add('hidden'); document.getElementById('loginOverlay').classList.add('hidden');
            document.getElementById('staffView').classList.remove('hidden'); showPage('create');
        } else {
            document.getElementById('staffView').classList.add('hidden'); document.getElementById('publicView').classList.remove('hidden');
            window.currentUserEmail = null;
        }
    });
</script>

<script>
    let currentTrackedData = null; let html5QrcodeScanner = null;

    function openLogin() { document.getElementById('loginOverlay').classList.remove('hidden'); }
    function closeLogin() { document.getElementById('loginOverlay').classList.add('hidden'); }
    async function login() {
        const e = document.getElementById('loginEmail').value.trim(); const p = document.getElementById('loginPass').value.trim();
        if(!e||!p) return alert("Missing inputs");
        try { await window.signInWithEmailAndPassword(window.auth, e, p); } catch(err) { alert(err.message); }
    }
    function logout() { window.signOut(window.auth).then(() => location.reload()); }

    function showPage(id) {
        document.querySelectorAll('.staff-page').forEach(d => d.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        
        // CAMERA HANDLING
        if(id === 'scanner') startCamera(); 
        else stopCamera();
        
        if(id === 'users') loadLogs();
        document.getElementById('printArea').innerHTML = '';
        document.getElementById('printArea').style.display = 'none';
    }

    // --- CAMERA FUNCTIONS (FIXED) ---
    function stopCamera() {
        if (html5QrcodeScanner) {
            html5QrcodeScanner.clear().catch(e => console.log(e));
            html5QrcodeScanner = null;
        }
    }

    function startCamera() {
        stopCamera();
        html5QrcodeScanner = new Html5QrcodeScanner("reader", { 
            fps: 10, 
            qrbox: 250,
            aspectRatio: 1.0
        });
        html5QrcodeScanner.render(onScanSuccess, (err) => {});
    }

    function onScanSuccess(decodedText) {
        // SUCCESS: STOP SCANNING & SHOW FORM
        html5QrcodeScanner.clear();
        document.getElementById('scanAction').classList.remove('hidden');
        document.getElementById('detectedWB').innerText = decodedText;
    }

    function resetScan() {
        document.getElementById('scanAction').classList.add('hidden');
        document.getElementById('currentLocSelect').value = "";
        document.getElementById('currentLocCustom').classList.add('hidden');
        
        // RESTART SCANNING
        startCamera();
    }

    // --- DYNAMIC LOCATION SYSTEM ---
    function loadLocations() {
        const select = document.getElementById('currentLocSelect');
        const defaultHubs = ["MNL HUB (Manila)", "DVO HUB (Davao)", "CEB HUB (Cebu)", "ILO HUB (Iloilo)", "CGY HUB (Cagayan)", "GES HUB (Gensan)", "Rider (On Delivery)", "DELIVERED"];

        // Listen to Database
        window.onSnapshot(window.doc(window.db, "settings", "locations"), 
        (docSnap) => {
            let hubs = defaultHubs;
            if (docSnap.exists() && docSnap.data().list) hubs = docSnap.data().list;
            
            // Ensure essentials exist
            if(!hubs.includes("DELIVERED")) hubs.push("DELIVERED");
            if(!hubs.includes("Rider (On Delivery)")) hubs.push("Rider (On Delivery)");

            hubs = [...new Set(hubs)].filter(h => h); // Clean list

            let options = `<option value="" disabled selected>Select Location / Action...</option>`;
            hubs.sort().forEach(hub => {
                options += `<option value="${hub}">${hub}</option>`;
            });
            options += `<option value="Other">‚ûï Add New Location...</option>`;
            select.innerHTML = options;
        });
    }

    function toggleCustomLoc() {
        const select = document.getElementById('currentLocSelect');
        const customInput = document.getElementById('currentLocCustom');
        if (select.value === "Other") { customInput.classList.remove('hidden'); customInput.focus(); } else { customInput.classList.add('hidden'); }
    }

    // --- SMART UPDATE STATUS ---
    async function updateStatus(){ 
        const wb = document.getElementById('detectedWB').innerText; 
        let l = document.getElementById('currentLocSelect').value;
        let isCustom = false;

        if(l === "Other") {
            l = document.getElementById('currentLocCustom').value.trim();
            isCustom = true;
        }

        if(!l) return alert("Select Location");

        // Logic for "Status" based on "Location"
        let s = "Arrived at Hub";
        const lu = l.toUpperCase();
        if (lu.includes("RIDER") || lu.includes("DELIVERY")) s = "Out for Delivery";
        else if (lu === "DELIVERED") s = "Delivered";
        else if (lu.includes("PICKED UP") || lu.includes("ORIGIN")) s = "Picked Up";

        try{ 
            // Update Parcel
            await window.updateDoc(window.doc(window.db,"parcels",wb), {
                currentStatus: s,
                history: window.arrayUnion({
                    status: s,
                    location: l,
                    time: new Date().toLocaleString(),
                    user: window.currentUserEmail
                })
            }); 
            
            // Save New Location if Custom
            if (isCustom) {
                const settingsRef = window.doc(window.db, "settings", "locations");
                await window.setDoc(settingsRef, {
                    list: window.arrayUnion(l)
                }, { merge: true });
            }

            alert(`Updated: ${s} @ ${l}`); 
            logAction("UPDATE", `${wb} -> ${s} @ ${l}`); 
            resetScan(); 

        } catch(e) {
            alert("Error: " + e.message);
        }
    }

    // --- AIRLINE TICKET LAYOUT (BOXED) ---
    function generatePrintLayout(data, startNum, endNum) {
        const printArea = document.getElementById('printArea');
        printArea.innerHTML = ""; printArea.style.display = 'flex';
        
        let destinationCode = "DOM";
        const dest = data.consignee.addr.toUpperCase();
        if(dest.includes("DAVAO")) destinationCode = "DVO";
        else if(dest.includes("MANILA") || dest.includes("MNL")) destinationCode = "MNL";
        else if(dest.includes("CEBU")) destinationCode = "CEB";
        else if(dest.includes("ILOILO")) destinationCode = "ILO";
        else if(dest.includes("CAGAYAN") || dest.includes("CDO")) destinationCode = "CGY";
        else if(dest.includes("GENSAN")) destinationCode = "GES";

        const totalPcs = parseInt(data.details.qty) || 1;
        const handling = data.details.handling || "Standard";
        const showWarning = (handling !== "Standard") ? "show" : "";

        for (let i = startNum; i <= endNum; i++) {
            const sticker = document.createElement('div');
            sticker.className = 'sticker-page';
            
            sticker.innerHTML = `
                <div class="wb-header">
                    <div class="wb-brand-box">
                        <img src="logo.png" class="wb-logo" onerror="this.style.display='none'">
                        <span class="wb-company-text">VG FREIGHTAGE DOMESTIC</span>
                    </div>
                    <span class="wb-date">${new Date().toLocaleDateString()}</span>
                </div>
                
                <div class="wb-sort-zone">${destinationCode}</div>
                <div class="wb-warning-banner ${showWarning}">${handling}</div>
                
                <div class="wb-qr-section">
                    <div class="wb-id-box">
                        <div class="wb-id-label">WAYBILL NUMBER</div>
                        <div class="wb-id-text">${data.waybill}</div>
                    </div>
                    <div id="qr-${data.waybill}-${i}" class="wb-qr-code"></div>
                </div>
                
                <div class="wb-sender">
                    <strong>FROM:</strong><br>
                    ${data.shipper.addr}
                </div>
                
                <div class="wb-receiver">
                    <div class="wb-tag">DESTINATION</div>
                    <div class="wb-rcv-name">${data.consignee.addr}</div>
                </div>
                
                <div class="wb-footer">
                    <div class="wb-f-item"><div class="wb-f-lbl">WEIGHT</div><div class="wb-f-val">${data.details.weight}</div></div>
                    <div class="wb-f-item"><div class="wb-f-lbl">PCS</div><div class="wb-f-val">${i}/${totalPcs}</div></div>
                    <div class="wb-f-item" style="font-size:8px;">Sign Here</div>
                </div>
            `;
            printArea.appendChild(sticker);
            new QRCode(document.getElementById(`qr-${data.waybill}-${i}`), { text: data.waybill, width: 140, height: 140 });
        }
    }
    
    function generateRandomWB(){ document.getElementById('wbInput').value="VG-"+Math.floor(100000+Math.random()*900000); }
    
    async function createParcel(){
        const wb=document.getElementById('wbInput').value;
        const d={
            waybill:wb,
            shipper:{ name: "Branch", addr: document.getElementById('shipperAddr').value, contact: "" }, // Origin
            consignee:{ name: "Branch", addr: document.getElementById('consigneeAddr').value, contact: "" }, // Destination
            details:{
                qty:document.getElementById('qty').value,
                weight:document.getElementById('weight').value,
                handling:document.getElementById('handling').value
            },
            currentStatus:"Accepted",
            createdBy:window.currentUserEmail,
            history:[{status:"Accepted",location:"Origin",time:new Date().toLocaleString(),user:window.currentUserEmail}]
        };
        if(!d.shipper.addr || !d.consignee.addr) return alert("Fill Branches");
        try{ await window.setDoc(window.doc(window.db,"parcels",wb),d); logAction("CREATE",wb); generatePrintLayout(d, 1, parseInt(d.details.qty)); setTimeout(()=>window.print(),800); }catch(e){alert("Error");}
    }

    // OTHER FUNCTIONS
    async function publicTrack(){ trackLogic(document.getElementById('publicSearchInput').value.trim(), document.getElementById('publicResult')); }
    async function staffTrackParcel(){ 
        const wb=document.getElementById('staffTrackInput').value.trim(); const r=document.getElementById('staffTrackResult'); 
        document.getElementById('reprintSection').classList.add('hidden'); 
        const d=await trackLogic(wb,r); 
        if(d){ 
            currentTrackedData=d; 
            document.getElementById('reprintSection').classList.remove('hidden'); 
            document.getElementById('rpEnd').value = d.details.qty;
        } 
    }
    
    async function trackLogic(wb, c){ if(!wb)return alert("Enter Waybill"); c.innerHTML="Loading..."; try{ const s=await window.getDoc(window.doc(window.db,"parcels",wb)); if(!s.exists()){c.innerHTML="Not Found";return null;} const d=s.data(); let h=""; d.history.reverse().forEach(x=>{h+=`<div class="timeline-item"><strong>${x.status}</strong><br><small>${x.location}</small><br><span class="text-muted" style="font-size:10px">${x.time}</span></div>`}); c.innerHTML=`<div class="col-md-8 mx-auto"><div class="card border-primary mb-3"><div class="card-header bg-primary text-white d-flex justify-content-between"><strong>${d.waybill}</strong> <span class="badge bg-light text-primary">${d.currentStatus}</span></div><div class="card-body"><div class="row g-3"><div class="col-6 border-end"><div class="track-label">Origin</div><div class="track-val mb-1">${d.shipper.addr}</div></div><div class="col-6"><div class="track-label">Destination</div><div class="track-val mb-1 text-primary">${d.consignee.addr}</div></div></div><hr><div class="row text-center"><div class="col-4"><div class="track-label">Qty</div><div class="track-val">${d.details.qty}</div></div><div class="col-4"><div class="track-label">Weight</div><div class="track-val">${d.details.weight}</div></div><div class="col-4"><div class="track-label">Encoder</div><div class="track-val">${d.createdBy || 'Admin'}</div></div></div></div></div><h6 class="fw-bold mt-4">History</h6><ul class="list-group border rounded">${h}</ul></div>`; return d; }catch(e){c.innerHTML="Error";return null;} }
    async function createStaffAccount(){ let e=document.getElementById('newEmail').value.trim().toLowerCase(); const p=document.getElementById('newPassword').value.trim(); if(!e||!p)return alert("Fill all"); if(confirm("Create user?")){ try{ await window.createUserWithEmailAndPassword(window.auth,e,p); await window.setDoc(window.doc(window.db,"users",e),{email:e,role:"Staff",createdBy:window.currentUserEmail}); alert("Created."); }catch(err){alert(err.message);} } }
    async function setRole(r){ let e=document.getElementById('manageEmail').value.trim().toLowerCase(); if(!e)return alert("Enter Email"); try{ await window.setDoc(window.doc(window.db,"users",e),{email:e,role:r},{merge:true}); alert(`Set ${e} to ${r}`); logAction("ROLE",`${e}->${r}`); }catch(err){alert(err.message);} }
    async function logAction(a,d){ try{await window.addDoc(window.collection(window.db,"logs"),{timestamp:new Date().toLocaleString(),user:window.currentUserEmail,action:a,details:d});loadLogs();}catch(e){} }
    async function loadLogs(){ try{const q=window.query(window.collection(window.db,"logs"),window.orderBy("timestamp","desc"),window.limit(20));const s=await window.getDocs(q);let h="";s.forEach(d=>{const l=d.data();h+=`<div class="border-bottom p-1"><strong>${l.action}</strong> ${l.details}<br><span style="font-size:9px">${l.timestamp} by ${l.user}</span></div>`});document.getElementById('logsContainer').innerHTML=h;}catch(e){} }
    async function exportToExcel() { const btn = document.querySelector('button[onclick="exportToExcel()"]'); const origText = btn.innerText; btn.innerText = "Downloading Data..."; btn.disabled = true; try { const q = window.query(window.collection(window.db, "parcels"), window.orderBy("waybill", "desc")); const querySnapshot = await window.getDocs(q); if (querySnapshot.empty) { alert("No data."); btn.innerText = origText; btn.disabled = false; return; } let csvContent = "Waybill,Status,Origin,Destination,Qty,Weight,Encoded By,Handling,Latest Update\n"; querySnapshot.forEach(doc => { const d = doc.data(); const clean = (text) => text ? `"${text.toString().replace(/"/g, '""')}"` : ""; const lastHist = d.history && d.history.length > 0 ? d.history[d.history.length - 1] : { time: '', location: '' }; const lastUpdate = `${lastHist.status} at ${lastHist.location} (${lastHist.time})`; csvContent += `${clean(d.waybill)},${clean(d.currentStatus)},${clean(d.shipper.addr)},${clean(d.consignee.addr)},${clean(d.details.qty)},${clean(d.details.weight)},${clean(d.createdBy)},${clean(d.details.handling)},${clean(lastUpdate)}\n`; }); const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob); const link = document.createElement("a"); link.setAttribute("href", url); link.setAttribute("download", `VG_Cargo_Report_${new Date().toLocaleDateString()}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link); } catch (e) { alert("Export Failed: " + e.message); } btn.innerText = origText; btn.disabled = false; }
    
    function reprintRange() { if(!currentTrackedData) return; const start = parseInt(document.getElementById('rpStart').value); const end = parseInt(document.getElementById('rpEnd').value); const total = parseInt(currentTrackedData.details.qty); if(start < 1 || end > total || start > end) return alert(`Invalid Range. Max is ${total}.`); generatePrintLayout(currentTrackedData, start, end); setTimeout(() => window.print(), 800); }

    window.login=login;window.logout=logout;window.openLogin=openLogin;window.closeLogin=closeLogin;
    window.publicTrack=publicTrack;window.showPage=showPage;window.createParcel=createParcel;window.generateRandomWB=generateRandomWB;
    window.staffTrackParcel=staffTrackParcel;window.updateStatus=updateStatus;window.resetScan=resetScan;
    window.createStaffAccount=createStaffAccount;window.setRole=setRole;window.exportToExcel=exportToExcel;
    window.toggleCustomLoc=toggleCustomLoc;
    window.loadLocations=loadLocations;
    window.reprintRange=reprintRange;
</script>
</body>
</html>
